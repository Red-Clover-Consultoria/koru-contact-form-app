!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).KoruWidgetSDK={})}(this,function(t){"use strict";function e(t,e,i,o){return new(i||(i=Promise))(function(r,s){function n(t){try{d(o.next(t))}catch(t){s(t)}}function a(t){try{d(o.throw(t))}catch(t){s(t)}}function d(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(n,a)}d((o=o.apply(t,e||[])).next())})}"function"==typeof SuppressedError&&SuppressedError;t.KoruWidget=class{constructor(t){this.config={},this.authData=null,this.container=null,this.isInitialized=!1,this.widgetName=t.name,this.widgetVersion=t.version,this.options=Object.assign({cache:!0,cacheDuration:3600,retryAttempts:3,retryDelay:1e3,analytics:!1,debug:!1},t.options);const e=this.getCurrentScript();if(!e)throw new Error("[Widget SDK] Could not find script tag");if(this.websiteId=e.getAttribute("data-website-id")||"",this.appId=e.getAttribute("data-app-id")||"",this.koruUrl=e.getAttribute("data-app-manager-url")||"",this.customData=e.getAttribute("data-custom-data")||"",!this.websiteId||!this.appId||!this.koruUrl)throw new Error("[Widget SDK] Missing required data attributes");this.log("SDK initialized",{websiteId:this.websiteId,appId:this.appId})}start(){return e(this,void 0,void 0,function*(){try{if(yield this.waitForDOM(),this.authData=yield this.authorize(),!this.authData.authorized)return void this.log("Widget not authorized");this.config=this.authData.config,yield this.onInit(this.config),yield this.onRender(this.config),this.isInitialized=!0,this.log("Widget started successfully"),this.options.analytics&&this.track("widget_loaded",{widget:this.widgetName,version:this.widgetVersion})}catch(t){this.handleError("Failed to start widget",t)}})}stop(){return e(this,void 0,void 0,function*(){try{yield this.onDestroy(),this.isInitialized=!1,this.log("Widget stopped")}catch(t){this.handleError("Failed to stop widget",t)}})}reload(){return e(this,void 0,void 0,function*(){try{if(this.clearCache(),this.authData=yield this.authorize(),!this.authData.authorized)return;const t=this.authData.config;this.onConfigUpdate?yield this.onConfigUpdate(t):(yield this.onDestroy(),yield this.onRender(t)),this.config=t,this.log("Widget reloaded")}catch(t){this.handleError("Failed to reload widget",t)}})}authorize(){return e(this,void 0,void 0,function*(){if("undefined"!=typeof window&&window.__KORU_PREVIEW_CONFIG__)return this.log("Using Koru preview config"),{authorized:!0,config:window.__KORU_PREVIEW_CONFIG__,token:"preview-mode",app:{id:this.appId,name:"Preview Mode",description:"Widget running in Koru preview mode"},website:{id:this.websiteId,url:window.location.origin,is_ecommerce:!1,customer:"preview"}};if(this.options.cache){const t=this.getFromCache();if(t)return this.log("Using cached authorization"),t}let t=null;for(let e=1;e<=this.options.retryAttempts;e++)try{this.log(`Authorization attempt ${e}/${this.options.retryAttempts}`);let t=`${this.koruUrl}/api/auth/widget?website_id=${this.websiteId}&app_id=${this.appId}`;this.customData&&(t+=`&custom_data=${encodeURIComponent(this.customData)}`);const i=yield fetch(t,{method:"GET",headers:{"Content-Type":"application/json"}});if(!i.ok)throw new Error(`Authorization failed: ${i.status}`);const o=yield i.json();return this.options.cache&&this.saveToCache(o),o}catch(i){t=i,this.log(`Authorization attempt ${e} failed:`,i),e<this.options.retryAttempts&&(yield this.sleep(this.options.retryDelay))}throw t||new Error("Authorization failed")})}createElement(t,e){const i=document.createElement(t);if(e){const{className:t,style:o,onClick:r,children:s}=e,n=function(t,e){var i={};for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&e.indexOf(o)<0&&(i[o]=t[o]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(t);r<o.length;r++)e.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(t,o[r])&&(i[o[r]]=t[o[r]])}return i}(e,["className","style","onClick","children"]);t&&(i.className=t),o&&Object.assign(i.style,o),r&&i.addEventListener("click",r),s&&s.forEach(t=>{"string"==typeof t?i.appendChild(document.createTextNode(t)):i.appendChild(t)}),Object.assign(i,n)}return i}isMobile(){return/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}track(t,e){if(this.options.analytics)try{const i=`${this.koruUrl}/api/analytics`;fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({website_id:this.websiteId,app_id:this.appId,event_type:t,event_data:Object.assign({widget:this.widgetName,version:this.widgetVersion,custom_data:this.customData},e)})}).catch(t=>this.log("Analytics error:",t))}catch(t){this.log("Failed to track event:",t)}}log(t,...e){this.options.debug&&console.log(`[${this.widgetName}]`,t,...e)}handleError(t,e){console.error(`[${this.widgetName}] ${t}:`,e),this.options.analytics&&this.track("widget_error",{error:e instanceof Error?e.message:String(e),message:t})}getCurrentScript(){return document.currentScript}waitForDOM(){return e(this,void 0,void 0,function*(){if("loading"===document.readyState)return new Promise(t=>{document.addEventListener("DOMContentLoaded",()=>t())})})}sleep(t){return new Promise(e=>setTimeout(e,t))}getCacheKey(){return`koru_widget_${this.websiteId}_${this.appId}`}getFromCache(){try{const t=this.getCacheKey(),e=localStorage.getItem(t);if(!e)return null;const{data:i,timestamp:o}=JSON.parse(e);return(Date.now()-o)/1e3>this.options.cacheDuration?(this.clearCache(),null):i}catch(t){return null}}saveToCache(t){try{const e=this.getCacheKey();localStorage.setItem(e,JSON.stringify({data:t,timestamp:Date.now()}))}catch(t){this.log("Failed to cache auth data:",t)}}clearCache(){try{const t=this.getCacheKey();localStorage.removeItem(t)}catch(t){}}},Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=widget-sdk.min.js.map
